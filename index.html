<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¥é«˜åœ°åŒº é«˜é½¢è€…å‘ã‘æ–½è¨­ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding: 0; font-size: 18px; }
    #map { height: 85vh; width: 100%; }
    .filter-btns { text-align: center; margin: 10px 0; }
    .filter-btns button {
      margin: 5px; padding: 10px 18px; font-size: 18px; border-radius: 10px;
      border: none; background: #a0cfff; color: black;
    }
    .filter-btns button:hover { background: #6fbfff; cursor: pointer; }

    #shareBtn, #formBtn {
      position: fixed;
      bottom: 20px;
      z-index: 1000;
      padding: 10px 18px; font-size: 18px; border-radius: 10px; border: none; color: white;
    }
    #shareBtn {
      right: 20px;
      background: #28a745;
    }
    #formBtn {
      left: 20px;
      background: #007bff;
    }
    #shareBtn:hover, #formBtn:hover { opacity: 0.8; cursor: pointer; }

    .popup-content {
      line-height: 1.6;
      font-size: 16px;
    }
    .popup-distance {
      font-weight: bold;
      color: #d9534f;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center; font-size: 24px;">æ—¥é«˜åœ°åŒº é«˜é½¢è€…å‘ã‘æ–½è¨­ãƒãƒƒãƒ—</h2>
  <div class="filter-btns" id="filterArea"></div>
  <div id="map"></div>
  <button id="shareBtn">äººã«æ•™ãˆã‚‹</button>
  <button id="formBtn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSdJKVbxWMm9fVfd4MfdzsI_jvGvy_5Wwb6WodXpfQFiF8tZBg/viewform?usp=header', '_blank')">æƒ…å ±ã‚’æŠ•ç¨¿ã™ã‚‹</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([35.467222, 134.771509], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const genreIcons = {
      'åŒ»ç™‚æ©Ÿé–¢': 'ğŸ¥',
      'è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³': 'ğŸ©º',
      'é«˜é½¢è€…ç¦ç¥‰æ–½è¨­': 'ğŸ§“',
      'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹': 'ğŸš',
      'ç¦ç¥‰ç›¸è«‡çª“å£': 'ğŸ“',
      'ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼': 'ğŸš–',
      'è²·ã„ç‰©': 'ğŸ›',
      'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢ãƒ»è–¬å±€': 'ğŸ’Š',
      'å…¬åœ’': 'ğŸŒ³',
      'çŒ«ã‚«ãƒ•ã‚§': 'ğŸ±',
      'å¤šç›®çš„ãƒˆã‚¤ãƒ¬': 'ğŸš»',
      'åœ°åŒºã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚»ãƒ³ã‚¿ãƒ¼': 'ğŸ¢',
      'ã“ã©ã‚‚é£Ÿå ‚': 'ğŸ½'
    };

    let allMarkers = [];
    let markerGroup = L.layerGroup().addTo(map);

    function displayInfo(info, lat, lng) {
      const userLat = map.getCenter().lat;
      const userLng = map.getCenter().lng;
      const dist = distance(userLat, userLng, lat, lng);
      const min = Math.round((dist / 4) * 60);
      return {
        address: info['ä½æ‰€'] || 'ã¾ã æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
        tel: info['é›»è©±ç•ªå·'] || 'ã¾ã æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
        hours: info['å–¶æ¥­æ™‚é–“'] || 'ã¾ã æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
        closed: info['å®šä¼‘æ—¥'] || 'ã¾ã æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
        homepage: info['ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸'] ? `<a href="${info['ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸']}" target="_blank">ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸</a>` : 'ã¾ã æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
        comment: info['ã‚³ãƒ¡ãƒ³ãƒˆ'] || 'ã¾ã æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
        distance: `${dist.toFixed(1)}kmï¼ˆå¾’æ­© ç´„${min}åˆ†ï¼‰`
      };
    }

    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function filterMarkers(genre) {
      markerGroup.clearLayers();
      const filtered = genre === 'ã™ã¹ã¦' ? allMarkers : allMarkers.filter(m => m.genre === genre);
      filtered.forEach(m => {
        const icon = L.divIcon({ className: 'custom-icon', html: `<div style="font-size:24px;">${genreIcons[m.genre] || 'ğŸ“'}</div>` });
        const info = displayInfo(m.values, m.lat, m.lng);
        const popup = `<div class='popup-content'><strong>${m.name}</strong><br>${m.genre}<br><br>
          ä½æ‰€ï¼š${info.address}<br>
          é›»è©±ï¼š${info.tel}<br>
          å–¶æ¥­æ™‚é–“ï¼š${info.hours}<br>
          å®šä¼‘æ—¥ï¼š${info.closed}<br>
          ${info.homepage}<br>
          ã‚³ãƒ¡ãƒ³ãƒˆï¼š${info.comment}<br>
          <div class='popup-distance'>ğŸ“ ç¾åœ¨åœ°ã‹ã‚‰ã®è·é›¢ï¼š${info.distance}</div><br>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}&travelmode=walking" target="_blank">ğŸš¶ å¾’æ­©ã§ãƒŠãƒ“</a><br>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}&travelmode=driving" target="_blank">ğŸš— è»Šã§ãƒŠãƒ“</a></div>`;
        L.marker([m.lat, m.lng], { icon }).bindPopup(popup).addTo(markerGroup);
      });
    }

    function updateFilterButtons(genres) {
      const container = document.getElementById('filterArea');
      container.innerHTML = '<button onclick="filterMarkers(\'ã™ã¹ã¦\')">ã™ã¹ã¦</button>';
      genres.forEach(genre => {
        const btn = document.createElement('button');
        btn.textContent = `${genreIcons[genre] || 'ğŸ“'} ${genre}`;
        btn.onclick = () => filterMarkers(genre);
        container.appendChild(btn);
      });
    }

    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTzWbO0ClxE1SKe-w-3yy-Zik5MmSYrL5b2Vg5O9O04XC4e3WaPOuGqBKWNQNeKsaQ1J34W1VfxnVd8/pub?gid=675439036&single=true&output=csv')
      .then(res => res.text())
      .then(csv => {
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        const rows = parsed.data.filter(row => row['ç·¯åº¦ï¼ˆlatï¼‰'] && row['çµŒåº¦ï¼ˆlngï¼‰']);

        const genreSet = new Set();

        allMarkers = rows.map(row => {
          const lat = parseFloat(row['ç·¯åº¦ï¼ˆlatï¼‰']);
          const lng = parseFloat(row['çµŒåº¦ï¼ˆlngï¼‰']);
          const genre = row['ã‚¸ãƒ£ãƒ³ãƒ«'];
          if (genre && genre.trim() !== '') genreSet.add(genre);
          return { name: row['æ–½è¨­å'], genre, lat, lng, values: row };
        }).filter(m => !isNaN(m.lat) && !isNaN(m.lng));

        updateFilterButtons([...genreSet]);
        filterMarkers('ã™ã¹ã¦');
      });

    document.getElementById('shareBtn').addEventListener('click', () => {
      const dummy = document.createElement('input');
      dummy.value = window.location.href;
      document.body.appendChild(dummy);
      dummy.select();
      document.execCommand('copy');
      document.body.removeChild(dummy);
      alert('ã“ã®ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
    });
  </script>
</body>
</html>
