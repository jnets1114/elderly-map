<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¥é«˜åœ°åŒº é«˜é½¢è€…å‘ã‘æ–½è¨­ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #fff9e6; margin: 0; padding: 0; font-size: 18px; }
    h2 { text-align: center; font-size: 26px; margin: 10px 0; color: #5a3825; }
    #map { height: 80vh; width: 100%; display: block; }
    .input-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 10px; }
    #filterSelect, #searchInput, #searchBtn { font-size: 18px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    #searchBtn { background-color: #8b5e3c; color: white; cursor: pointer; }
    #shareBtn, #formBtn {
      position: fixed; bottom: 20px; z-index: 1000; padding: 10px 18px; font-size: 18px;
      border-radius: 10px; border: none; color: white;
    }
    #shareBtn { right: 20px; background: #f4a261; }
    #formBtn { left: 20px; background: #2a9d8f; }
    #shareBtn:hover, #formBtn:hover, #searchBtn:hover { opacity: 0.8; }
  </style>
</head>
<body>
  <h2>æ—¥é«˜åœ°åŒº é«˜é½¢è€…å‘ã‘æ–½è¨­ãƒãƒƒãƒ—</h2>
  <div class="input-group">
    <select id="filterSelect"><option value="ã™ã¹ã¦">ã™ã¹ã¦ã®ã‚¸ãƒ£ãƒ³ãƒ«</option></select>
    <input type="text" id="searchInput" placeholder="æ–½è¨­åã§æ¤œç´¢...">
    <button id="searchBtn">æ¤œç´¢</button>
  </div>
  <div id="map"></div>
  <button id="shareBtn">äººã«æ•™ãˆã‚‹</button>
  <button id="formBtn" onclick="window.open('https://docs.google.com/forms/...', '_blank')">æƒ…å ±ã‚’æŠ•ç¨¿ã™ã‚‹</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const map = L.map('map', { zoomControl: false }).setView([35.467222, 134.771509], 14);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      const genreIcons = {
        'åŒ»ç™‚æ©Ÿé–¢': 'ğŸ¥', 'è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³': 'ğŸ’—', 'é«˜é½¢è€…ç¦ç¥‰æ–½è¨­': 'ğŸ ',
        'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹': 'ğŸš', 'ç¦ç¥‰ç›¸è«‡çª“å£': 'ğŸ“', 'ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼': 'ğŸš•',
        'è²·ã„ç‰©': 'ğŸ›ï¸', 'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢ãƒ»è–¬å±€': 'ğŸ’Š', 'å…¬åœ’': 'ğŸŒ²',
        'çŒ«ã‚«ãƒ•ã‚§': 'ğŸ±', 'å¤šç›®çš„ãƒˆã‚¤ãƒ¬': 'â™¿', 'åœ°åŒºã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚»ãƒ³ã‚¿ãƒ¼': 'ğŸ›ï¸', 'ã“ã©ã‚‚é£Ÿå ‚': 'ğŸ›'
      };

      let allMarkers = [], filteredMarkers = [], markerGroup = L.layerGroup().addTo(map);

      function displayInfo(info) {
        return {
          address: info['ä½æ‰€'] || 'æƒ…å ±ãªã—',
          tel: info['é›»è©±ç•ªå·'] || 'æƒ…å ±ãªã—',
          hours: info['å–¶æ¥­æ™‚é–“'] || 'æƒ…å ±ãªã—',
          closed: info['å®šä¼‘æ—¥'] || 'æƒ…å ±ãªã—',
          homepage: info['ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸'] ? `<a href="${info['ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸']}" target="_blank">HP</a>` : 'æƒ…å ±ãªã—',
          comment: info['ã‚³ãƒ¡ãƒ³ãƒˆ'] || 'æƒ…å ±ãªã—'
        };
      }

      function createIcon(genre, zoom) {
        const size = zoom < 14 ? 20 : zoom < 16 ? 28 : 36;
        return L.divIcon({ className: 'custom-icon', html: `<div style="font-size:${size}px;">${genreIcons[genre] || 'ğŸ“'}</div>` });
      }

      function renderMarkers(markers) {
        markerGroup.clearLayers();
        const zoom = map.getZoom();
        markers.forEach(m => {
          const icon = createIcon(m.genre, zoom);
          const info = displayInfo(m.values);
          const popup = `<div style='font-size:16px;'>
            <strong style='font-size:18px;'>${m.name}</strong><br>
            <span>${m.genre}</span><br>
            ä½æ‰€: ${info.address}<br>
            é›»è©±: ${info.tel}<br>
            å–¶æ¥­æ™‚é–“: ${info.hours}<br>
            å®šä¼‘æ—¥: ${info.closed}<br>
            ${info.homepage}<br>
            ã‚³ãƒ¡ãƒ³ãƒˆ: ${info.comment}
          </div>`;

          const marker = L.marker([m.lat, m.lng], { icon }).addTo(markerGroup);
          marker.bindPopup(popup);

          marker.on('click', () => {
            const target = marker.getLatLng();
            const currentZoom = map.getZoom();
            const zoom = currentZoom < 16 ? 16 : currentZoom;
            map.setView(target, zoom, { animate: true });
            marker.openPopup();
          });

          m.marker = marker;
        });
      }

      function filterAndSearch() {
        const genre = document.getElementById('filterSelect').value;
        const keyword = document.getElementById('searchInput').value.trim();
        filteredMarkers = allMarkers.filter(m => {
          const matchGenre = genre === 'ã™ã¹ã¦' || m.genre === genre;
          const matchName = keyword === '' || m.name.includes(keyword);
          return matchGenre && matchName;
        });

        renderMarkers(filteredMarkers);

        if (filteredMarkers.length === 1) {
          const m = filteredMarkers[0];
          map.setView([m.lat, m.lng], 16);
          m.marker.openPopup();
        } else if (filteredMarkers.length > 1) {
          const latLngs = filteredMarkers.map(m => L.latLng(m.lat, m.lng));
          map.fitBounds(L.latLngBounds(latLngs), { padding: [50, 50] });
        }
      }

      map.on('zoomend', () => renderMarkers(filteredMarkers));

      fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTzWbO0ClxE1SKe-w-3yy-Zik5MmSYrL5b2Vg5O9O04XC4e3WaPOuGqBKWNQNeKsaQ1J34W1VfxnVd8/pub?gid=675439036&single=true&output=csv')
        .then(res => res.text())
        .then(csv => {
          const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
          const rows = parsed.data.filter(row => row['ç·¯åº¦ï¼ˆlatï¼‰'] && row['çµŒåº¦ï¼ˆlngï¼‰']);
          const genreSet = new Set();

          allMarkers = rows.map(row => {
            const lat = parseFloat(row['ç·¯åº¦ï¼ˆlatï¼‰']);
            const lng = parseFloat(row['çµŒåº¦ï¼ˆlngï¼‰']);
            const genre = row['ã‚¸ãƒ£ãƒ³ãƒ«'];
            if (genre) genreSet.add(genre);
            return { name: row['æ–½è¨­å'], genre, lat, lng, values: row };
          });

          const select = document.getElementById('filterSelect');
          genreSet.forEach(genre => {
            const option = document.createElement('option');
            option.value = genre;
            option.textContent = `${genreIcons[genre] || 'ğŸ“'} ${genre}`;
            select.appendChild(option);
          });

          document.getElementById('filterSelect').addEventListener('change', filterAndSearch);
          document.getElementById('searchBtn').addEventListener('click', filterAndSearch);

          filteredMarkers = allMarkers;
          renderMarkers(filteredMarkers);
        });

      document.getElementById('shareBtn').addEventListener('click', () => {
        const dummy = document.createElement('input');
        dummy.value = window.location.href;
        document.body.appendChild(dummy);
        dummy.select();
        document.execCommand('copy');
        document.body.removeChild(dummy);
        alert('ã“ã®ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      });
    });
  </script>
</body>
</html>
